[TOC]

# 函数

通过 SQL 对数据进行某操作或计算时需要使用 **函数**

函数：输入某一值得到相应输出结果功能，输入值称 **参数**，输出值称为 **返回值**

大致分以下几种：

- 算术：进行数值计算
- 字符串：进行字符串操作
- 日期：日期操作
- 转换：转换数据类型和值
- 聚合：进行数据聚合

## 字符串

- `LENGTH`：字符串长度

    ```sql
    SELECT LENGTH(str)
    ```

    > **注意**：该函数无法在 SQL Server 使用，SQL Server 使用 `LEN` 计算字符串长度
    >
    > 该函数与半角英文占用 1 字节不同，汉字全角字符占用 2 字节，不同 DBMS 的执行结果也不尽相同

- `CONCAT(str1, str2)`：字符串拼接

    ```sql
    SELECT CONCAT('hello', ' world')
    ```

    > **注意**：如果包含 NULL，那么得到的结果也是 `NULL`
    >
    > **|| 函数在 SQL Server 和 MySQL 无法使用**
    >
    > **SQL Server：使用 `+` 号连接字符串**
    >
    > ```sql
    > str1 + str2
    > ```
    >
    > **MySQL：使用 CONCAT 完成字符串拼接**
    >
    > ```sql
    > CONCAT(str1, str2)
    > ```

- `LOWER` / `UPPER`：小写 / 大写转换

  ```sql
  SELECT LOWER / UPPER (str)
  ```

  > **注意**：**只能针对英文字母使用，将参数中的字符串全都转换为小写**
  >
  > **并不适用于英文字母以外的场合**

- `TRIM(str)、LTRIM / RTRIM(str)`：删除空格

  ```sql
  SELECT TRIM(str)
  ```

- `REPLACE`：字符串转换

  ```sql
  SELECT REPLACE (str, 替换前字符串, 替换后字符串)
  ```

- `SUBSTRING`：字符串截取

  ```sql
  SELECT SUBSTRING (str FROM 截取起始位置 FOR 截取的字符串)
  ```

  使用 `SUBSTRING` 截取出字符串中的一部分字符串

  截取的起始位置从字符串最左侧开始计算

  > **注意**：**只有 PostgreSQL 和 MySQL ** 支持该语法
  >
  > **SQL Server**
  >
  > ```sql
  > SUBSTRING (str, 截取起始位置, 截取字符数)
  > ```
  >
  > **Oracle 和 DB2**
  >
  > ```sql
  > SUBSTR (str, 截取起始位置, 截取字符数)
  > ```

## 日期时间

其中大部分都依存于各自的 DBMS

- `CURRENT_DATE` / `CURDATE()`：**当前日期**，由于没有参数，因此无需使用括号

  ```sql
  SELECT CURRENT_DATE
  ```

  > **无法在 SQL Server 中执行，Oracle 和 DB2 中的语法略有不同**
  >
  > **SQL Server**：**CURRENT_TIMESTAMP** 
  >
  > ```sql
  > SELECT CAST(CURRENT_TIMESTAMP AS DATE) AS CUR_DATE;
  > ```
  >
  > **Oracle**：需要在 FROM 指定临时表（DUAL）
  >
  > 而在 **DB2** 中使用时，需要在 CRUUENT 和 DATE 之间添加半角空格
  >
  > 并需要指定临时表 `SYSIBM.SYSDUMMY1`
  >
  > ```sql
  > -- Oracle
  > SELECT
  > 	CURRENT_DATE
  > FROM
  > 	dual;
  > 
  > -- DB2
  > SELECT
  > 	CURRENT DATE
  > FROM
  > 	SYSIBM.SYSDUMMY1;
  > ```

- `CURRENT_TIME`：**当前时间**

  ```sql
  SELECT CURRENT_TIME
  ```

  > **SQL Server**
  >
  > ```sql
  > SELECT CAST(CURRENT_TIMESTAMPE AS TIME) AS CUR_TIME;
  > ```
  >
  > **Oracle** 和 **DB2**
  >
  > ```sql
  > -- Oracle
  > SELECT
  > 	CURRENT_TIMESTAMPE
  > FROM
  > 	dual;
  > 
  > -- DB2
  > SELECT
  > 	CURRENT TIME
  > FROM
  > 	SYSIBM.SYSDUMMY1;
  > ```

- `CURRENT_TIMESTAMP` / `LOCALTIME()` / `NOW()` / `SYSDATE()`：**当前日期和时间**

  ```sql
  SELECT CURRENT_TIMESTAMP
  ```

  具有 CURRENT_DATE + CURRENT_TIME 的功能，同时得到当前日期和时间

  > **在 SQL Server 等各个主要的 DBMS 中使用** 
  >
  > **在 Oracle 和 DB2 中该函数的语法略有不同**
  >
  > ```sql
  > -- Oracle
  > SELECT
  > 	CURRENT_TIMESTAMPE 
  > FROM
  > 	dual;
  > 	
  > -- DB2
  > SELECT CURRENT TIMESTAMP 
  > FROM
  > 	SYSIBM.SYSDUMMY1;
  > ```

- `UTC_DATE` / `UTC_TIMESTAMP` / `UTC_TIME`：获取 UTC 日期时间

    ```sql
    SELECT UTC_DATE
    ```

- `DATE_FORMAT(date, format)`：日期时间格式化
    
    | 格式 | 描述 |
    | --- | --- |
    | %y / %Y | 年，2 / 4 位 |
    | %m / %M | 月，2位 / 名称 |
    | %d / %D | 年，2位 / 每月第几天 |
    | %h / %I | 12 小时制 |
    | %H | 24 小时制 |
    | %i | 分钟 |
    | %s / %S | 秒 |

    ```sql
    SELECT DATE_FORMAT(CURRENT_TIMESTAMP, '%y年%m月%d天');

    SELECT DATE_FORMAT(CURRENT_TIME, '%H小时%i分钟%s秒');
    ```

## 日期时间计算函数

| 单位选项 | 含义 |
| --- | --- |
| YEAR | 年 |
| MONTH | 月 |
| DAY | 日 |
| HOUR | 小时 |
| MINUTE | 分钟 |
| SECOND | 秒钟 |
| MICROSECOND | 微秒 |

- `DATE_ADD` / `ADDDATE`：日期增加

    ```sql
    SELECT DATE_ADD(date, INTERVAL expr unit)

    SELECT CURRENT_TIMESTAMP, DATE_ADD(CURRENT_TIMESTAMP, INTERVAL 1 HOUR);
    ```

- `DATE_SUB` / `SUBDATE`：日期增加

    ```sql
    SELECT DATE_SUB(date, INTERVAL expr unit);
    ```

- `ADDTIME` / `SUBTIME`：时间加减

    ```sql
    SELECT ADDTIME(expr1, expr2);

    SELECT CURRENT_TIME, ADDTIME(CURRENT_TIME, "00:05:00");
    ```

## 聚合统计

用于汇总的函数称为 **聚合函数** 或 **聚集函数**，所谓 **聚合**，将多行汇总为一行。

- `COUNT`：统计总行数

    ```sql
    SELECT COUNT(purchase_price) FROM Product;
    ```

  > `COUNT` **函数的结果根据参数的不同而不同**
  >
  > `COUNT(*)`：**会得到包含 NULL 的数据行数**
  >
  > `COUNT(column_name)`：**会得到 NULL 之外的数据行数**

- `SUM`：指定列的总和

    ```sql
    SELECT SUM(price) FROM Product;
    ```

  > **聚合函数会将 NULL 排除在外。但 `COUNT(*)` 例外，并不会排除 NULL**

- `AVG`：指定列的平均数

    ```sql
    SELECT AVG(sale_price) FROM Product;
    ```

  > **与 SUM 函数相同，先删除 NULL 再进行计算**

- `MAX` / `MIN`：指定列的最大 / 最小值

    ```sql
    SELECT MAX( sale_price ),
           MIN ( sale_price ) 
    FROM
        Product;
    ```

  > **`MAX / MIN` 函数适用于所有数据类型的列，`SUM / AVG` 只适用与数值类型的列**

- 使用聚合函数 `DISTINCT` 删除重复值

    ```sql
    -- 计算去除重复数据后的数据行数
    SELECT COUNT
        ( DISTINCT product_type ) 
    FROM
        Product;
    ```

    > **计算值的种类时，可在 `COUNT` 函数参数中使用 `DISTINCT`，必须在括号中**
    >
    > **不仅限于 `COUNT` 函数，所有聚合函数都可以使用 `DISTINCT`**


## 数学

- `ABS`：绝对值，不考虑数值的符号，表示一个数到原点的距离

    **0 和正数的绝对值是其本身，负数的绝对值是去掉符号后的结果**

    ```sql
    SELECT ABS(-10)  -- 10
    ```

- `MOD`：求余，计算除法余数（余数）

    ```sql
    SELECT MOD (被除数, 除数)
    ```

    **小数计算没有余数的概念，只能对整数类型的列使用 `MOD` 函数**

    > **注意**：**只有 SQL Server 不支持该函数**
    >
    > **SQL Server 使用特殊的运算符（函数）"%" 计算余数**

- `ROUND`：四舍五入

    ```sql
    ROUND (对象数值, 保留小数的位数)
    ```

    **如果指定位数为 1，对小数点第 2 位四舍五入，指定位数为 2，对第 3 位进行处理**


- `SQRT`：平方根

    ```sql
    SELECT SQRT(4)  -- 2
    ```
  
- `RAND`：取一个 0 ~ 1 之间的随机数

    ```sql
    SELECT RAND() -- 默认 0 ~ 1 之间的随机数
  
    -- 如果求 100 以内的随机数，对其乘以 100
    SELECT RAND() * 100
    ```
  
- `CEIL / FLOOR`：向上 / 向下取整

    ```sql
    SELECT FLOOR(1.5), CEIL(1.5)
  
    -- 对 100 以内的随机数向下取整
    SELECT FLOOR(RAND() * 100)
    ```

- `SIN / COS / TAN`：三角函数

- `LOG`：对数函数

## 其他常用

- IF 条件判断：`IF (expr1, expr2, expr3)`

    满足条件 `expr1` 返回 `expr2`，否则返回 `expr3`
    
    ```sql
    SELECT IF(sex = '男', '男士', '女士') FROM Student_info;
    ```
  
- `VERSION`：获取数据库版本号

    ```sql
    SELECT VERSION();
    ```
  
- `MD5(s) / SHA(s) / SHA2(s, l)`： 加密函数

    ```sql
    SELECT MD5('password')
    ```
  
    > **注意**：Mysql 8.0 之后的新函数