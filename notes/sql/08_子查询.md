[TOC]

# 子查询

## 别名

### 为输出列指定别名

使用 `AS` 为列设定 **别名**，改变输出的名称（不会改变其输出值）

```sql
SELECT
    column_name AS 'as_name'
FROM
    table;
```

> 别名可使用中文，但需要 **双引号** 括起

### 为表指定别名

```sql
SELECT
    t.tag
FROM
    table [AS] t;
```

> 在 Oracle 的 FROM 子句中，不能使用 `AS`（发生错误）

## 子查询

一个查询语句嵌套在另一个查询语句内部的查询

用来定义视图的 `SELECT` 语句直接用于 `FROM` 子句当中

**子查询名称**

原则上子查询必须设定名称，因此请大家尽量从处理内容角度出发为子查询设定恰当的名称

为子查询设定名称时需要使用 `AS` 关键字，有时可省略（Oracle）

### 标量子查询

**标量**：单一的意思，有个特殊限制，**必须而且只能返回 1 行 1 列的结果**，返回表中某行某列的值

标量子查询的返回值可用在 `=` 或 `<>` 需要单一值的比较运算符中

```sql
-- 在 WHERE 子句中使用标量子查询
SELECT
    product_id, product_name, sale_price
FROM
    Product
WHERE sale_price > AVG(sale_price);

-- 计算平均销售单价
SELECT AVG(sale_price)
FROM Product;

-- 选取销售单价高于全部商品的平均单价商品
SELECT
    product_id, product_name, sale_price
FROM
    Product
WHERE sale_price > (
    SELECT AVG(sale_price)
    FROM Product);
```

> **注意**：首先执行内层子查询，将结果带入外层 WHERE 中，执行外层查询
>
> **书写位置**
>
> 不仅限于 `WHERE` 中，通常任何可使用单一值的位置都可使用：常数或列名、`SELECT`、`GROUP BY`、`HAVING`、`ORDER BY`

### 标量子查询注意事项

**不能返回多行结果**， 如果返回了多行结果，仅仅是一个普通子查询，

因此不能用在 `=` 或 `<>` 等需要单一输入值的运算符中，不能使用 `SELECT` 等子句中

### 关联子查询

- 普通子查询

    ```sql
    -- 错误子句
    SELECT product_id, product_name, sale_price
    FROM Product
    WHERE sale_price > (
        SELECT AVG(sale_price)
        FROM Product
        GROUP BY product_type);
    ```

    > 在 WHERE 子句中使用子查询时，该子查询结果必须单一的

- 关联子查询

    ```sql
    SELECT product_type, product_name, sale_price
    FROM Product AS P1
    WHERE sale_price > (
        SELECT AVG(sale_price)
        FROM Product AS P2
        WHERE P1.product_type = P2.product_type
        GROUP BY product_type);
    ```
  
    > 在子查询中添加 `WHERE` 子句条件，比较对象分别使用 P1 / P2 别名进行区分

    ```sql
    -- 错误关联子查询书写方法
    SELECT product_type, product_name, sale_price
    FROM Product AS P1
    WHERE P1.product_type = P2.product_type -- 错误位置
        AND sale_price > (
            SELECT AVG(sale_price)
            FROM Product AS P2
            GROUP BY product_type); 
    ```
    > 必须将关联条件写在子查询之外的外层查询之中
    > 
    > 违反了**关联名称**的**作用域（有效范围）**，关联名称存在一个有效范围的限制
    > 
    > 子查询内部设定的关联名称，只能在该子查询内部使用，按照该**先内层子查询后外层查询的顺序执行**