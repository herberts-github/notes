[TOC]

# 分组与去重


- 使用 `DISTINCT` 去重
- 使用 `GROUP BY` 分组

```sql
SELECT
    select_expr, ...
FROM
    table_references
[WHERE where_definition]
[GROUP BY {col_name | expr | position}]
[HAVING where_definition]
[ORDER BY {col_name | expr | position} [ASC | DESC], ...]
[LIMIT {[offset], row_count}]
```

## DISTINCT 去重

DISTINCT 从查询结果删除重复数据

```sql
-- 计算去重数据后的数据行数
SELECT COUNT(
    DISTINCT product_type)
FROM
    Product;
```

> 计算值种类时，在 `COUNT` 函数参数中使用 `DISTINCT`（括号中）
> 
> **不仅限 `COUNT` 函数，所有聚合函数都可使用 `DISTINCT`**

## GROUP BY 分组

通过聚合函数和 `GROUP BY`，根据 `col_name` 将表分割后在汇总

```sql
SELECT
    column_name1, column_name2, COUNT(*)...
FROM
    table
GROUP BY column_name1, column_name2, ...;
```

未使用 `GROUP BY` 时，默认将表中所有数据作为一组对待

在 `GROUP BY` 中指定列称为 **聚合键** 或 **分组列**

> SQL 顺序不能改变，也不能互相替换：
> 
> `SELECT - > FROM -> WHERE -> GROUP BY`
> 
> `SELECT` 中的字段 **只能** 是 `GROUP BY` 中的字段或聚合函数

### WHERE 时 GROUP BY 执行结果

```sql
SELECT
    column_name1, column_name2, COUNT(*)...
FROM
    table
WHERE expr
GROUP BY column_name1, column_name2, ...;
```

> 根据 `WHERE` 指定条件进行过滤，然后进行汇总处理
>
> **执行顺序**
>
> `FROM -> WHERE -> GROUP BY -> SELECT`

### 聚合函数和 GOURP BY 常见错误

1. 使用 `GROUP BY` 时，`SELECT` 不能出现聚合键之外的列名
   
    使用聚合函数时，`SELECT` 只能存在：
    
    - 常数
    - 聚合函数
    - GROUP BY 指定的列名（聚合键）

    **ERROR：把聚合键之外的列名书写在 `SELECT` 中**

   ```sql
   SELECT
       product_name,
       purchase_price,
       COUNT ( * ) 
   FROM
       Product 
   GROUP BY
       purchase_price;
   ```
   
    > **只有 MySQL 支持，以外的 DBMS 不支持**

2. GROUP BY 不能使用 SELECT 中列的别名

   ```sql
   SELECT
       product_type AS TYPE,
       COUNT ( * ) 
   FROM
       Product 
   GROUP BY
       TYPE;
   ```

   > **注意：PostgreSQL 和 MySQL 不会发生执行错误**
   >
   > **SQL 语句在 DBMS 内部执行顺序造成：**
   >
   > **SELECT 在 GROUP BY 之后执行，在执行 GROUP BY 时，SELECT 定义的别名还没执行**

3. GROUP BY 聚合结果是无序的

    顺序排列是 **随机** 的

    > **如果按照特定顺序进行 排序，需要在 SELECT 语句中进行指定**

4. WHERE 不能使用聚合函数

   ```sql
   -- ERROR
   SELECT
   	product_type,
   	COUNT ( * ) 
   FROM
   	Product 
   WHERE
   	COUNT ( * ) = 2 
   GROUP BY
   	product_type;
   ```

   > **只有 SELECT 和 HAVING 中能够使用 COUNT 等聚合函数**

## 为聚合结果指定条件

### HAVING

在分组后进行条件筛选（过滤分组）

> **注意**：`WHERE` 过滤行，而 `HAVING` 过滤分组

```sql
SELECT
    column_name1, column_name2, column_name3, ... 
FROM
	table
GROUP BY
    column_name1 > column_name2, column_name3, ... 
HAVING
    COUNT(1) > 2;
```

> **使用 HAVING 时的书写顺序**
>
> **SELECT -> FROM -> WHERE -> GROUP BY -> HAVING**

### HAVING 中构成要素

HAVING 和包含 GROUP BY 时的 SELECT 一样， 使用要素限制内容完全相同

- 常数
- 聚合函数
- GROUP BY 中指定列名（聚合键）

### 相对HAVING，更适合WHERE的条件

WHERE 和 HAVING 作用不同

- WHERE ：指定行所对应的条件

- HAVING：指定组所对应的条件

> **聚合键所对应的条件不应该书写在 HAVING 中，而应该书写在 WHERE 中**
>
> **WHERE 和 HAVING 执行速度：**
>
> - **WHERE 指定条件时，由于排序之前对数据进行过滤，能减少排序的数据量**
>
> - **HAVING 是在排序之后才对数据进行分组的**
>
> **可对 WHERE 指定条件所对应的列创建 索引，可大幅提高处理速度**
